---
title: 'Stats 506 Group Project '
author: "Group 10: Karthik G, Xinjun Li and Jingyan Lu"
date: "12/9/2019"
output:
html_document:
df_print: paged
toc: true
toc_depth: 2
toc_float: true
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      engine.path = list(
  python = 'C:/Users/xinjun li/AppData/Local/Programs/Python/Python37/python.exe')
  )
# libraries:
# library(SASxport)
library(tidyverse)
# library(MBESS)
```


# Introduction

Our project aims to answer the question:
"Is salt intake associated with blood pressure? If so, to what extent is that relationship mediated or moderated by age or waist size?" 

By raising the question, we want to know whether the salt intake behavior of a person is related to the person's blood pressure levels and want to know further if this relationship is dependent on the waist measurement of the person.

The analysis would be a moderation analysis testing whether there exists a relationship between salt intake and blood pressure levels and if this relationship is moderated by waist measurement.

As a follow up analysis, we will study "whether the salt intake habit of a person is related to the person's blood pressure levels and identify whether age is a mechanism underlying the relationship between the two", i.e., is age a mediator between the relationship between salt intake and blood pressure levels? This would be a mediation analysis with a confidence interval-based bootstrapping approach.
<br>
  
# Data
  
We use [NHANES](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx) data in 2015-2016 for analysis. Data of salt intake and people's diastole and systole blood pressure are needed in both moderation and mediation analysis. You can find them in the datasets [Dietary Interview - Total Nutient intakes, First Day](https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DR1TOT_I.htm), [Blood Pressure](https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BPX_I.htm) respectively.
  
For the moderation analysis, we use another dataset [Body Measures](https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/BMX_I.htm) for data of waist measurement.
  
For the mediation analysis, data of participants' age from [Demographic variables and Sample Weights](https://wwwn.cdc.gov/Nchs/Nhanes/2015-2016/DEMO_I.htm) is used.
<br>
```{r, echo = FALSE}
name = c("DBD100", "DI", "SY", "RIDAGEYR", "BMXWAIST")
description = c("How often add salt to food at table", 
                "Diastolic: Mean of blood pressure from three times reading (mm Hg)", 
                "Systole: Mean of blood pressure from three times reading (mm Hg)", 
                "Age in years at screeening", 
                "Wasit circumference (cm)")
dataset = c("DR1TOT_I.XPT", "BPX_I.XPT", "BPX_I.XPT", "DEMO_I.XPT", "BMX_I.XPT")
data.table(Variables = name, Descriptions = description, Datasets = dataset) %>%
  knitr::kable(align = "l") %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), latex_options = c("hold_position", "scale_down"), position = "left")
```
<br>

# Methods

Moderation and Mediation analysis are used in our projects. To explain the moderation analysis, We start with the relationship between an independent variable x and a dependent variable Y. For example, in our case, X is the salt intake and Y is the blood pressure. we will prove it later that there is a relationship between them, which can be expressed as Y = beta0 + beta1 * X + error.

A moderator Z is a variable that can affect the direction or strength of the relationship between X and Y. If the effect of salt intake on the blood pressure depends on the level of waist size, then waist size is a moderator. Otherwise, blood pressure is not a moderator.

We perform moderation analysis by adding interaction term, which can be expressed as Y = beta0 + beta1 * X + beta2 * Z + beta3 * X * Z + error. If beta3 does not equal to 0, Z is supposed to be a moderator. In the regression model, we test whether the regression coefficient for the interaction term is significant or not.

Mediator explains the underlying mechanism of the relationship between independent variable and dependent variable. Let's assume that the independent variable X is a predictor for the dependent variable Y and the relationship is that X boosts Y. If M is a mediator, then the hypothesis is that X boosts M and then M boosts Y. Three steps of regression comprise a medation analysis: X to Y, X to M, X + M to Y. 

First, we need to illustrate that X affects Y. If not, there is no need to mediate. Second, we try to figure out if X affect M. If there is no relationship between them, M may be another predictor or does not affect Y at all, instead of a mediator. M is a mediator only when there is relationship between X and M. The last step is to find if M affects Y, but X no longer affects Y. If the medation effect exists, the effect of X on Y will disappear or reduce to a samll magnitude when M is included in the model.

We use R, Python and SAS to perform the analysis.

<br>
  
# Moderation and Mediation {.tabset}


## R
  
### Load the data

```{r}
demographics = read.xport("C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Demographics_2015_16.XPT")
blood_pressure = read.xport("C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Blood_Pressure_2015_16.XPT")
nutrients_1day = read.xport("C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Dietary_nutrients_firstday_2015_16.XPT")
BMI = read.xport("C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Body_measures_2015_16.XPT")
```
<br>
  
### Data processing
  
```{r}
blood_pressure = blood_pressure %>%
  select(SEQN, BPXSY1, BPXSY2, BPXSY3, BPXDI1, BPXDI2, BPXDI3) %>%
  rowwise() %>%
  mutate(DI = mean(c(BPXDI1, BPXDI2, BPXDI3), na.rm=TRUE),
         SY = mean(c(BPXSY1, BPXSY2, BPXSY3), na.rm = TRUE)) %>%
  select(SEQN, DI, SY)

demographics = demographics %>% 
  select(SEQN, RIDAGEYR)

nutrients_1day = nutrients_1day %>%
  select(SEQN, DBD100)

BMI = BMI %>%
  select(SEQN, BMXWAIST)

data = demographics %>%
  left_join(BMI, by = "SEQN") %>%
  left_join(nutrients_1day, by = "SEQN") %>%
  left_join(blood_pressure, by = "SEQN") 


data = data[complete.cases(data), ]
```

#### Center means to reduce multicolinearity

```{r}
data[c("RIDAGEYR", "BMXWAIST", "DBD100", "DI", "SY")] = 
  lapply(data[c("RIDAGEYR", "BMXWAIST", "DBD100", "DI", "SY")],  
         function(x) scale(x, center=TRUE, scale=FALSE))
```
<br>
  
### Analyse the relationship between salt intake and two kinds of blood pressure
<br>
  
#### For diastole blood pressure
  
```{r}
model_DI = lm(DI ~ DBD100, data)
summary(model_DI)
```
<br>
  
#### For systole blood pressure
  
```{r}
model_SY = lm(SY ~ DBD100, data)
summary(model_SY)
```


##### Both p-values are less than 0.001, which show strong evidence that salt intake have siginificant influence on both kinds of blood pressure.
<br>
  
### Moderation part

The structural model for the moderation analysis can be defined as seen in Figure 1

![Fig 1: Structural model for the moderation analysis](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig1.png)

##### We perform moderation to test if the relationship is dependent on the waist size. Three levels of a moderator(mean, one standard deviation above the mean and one standard deviation below the mean) is chosen.
 <br>

#### Moderation at mean for diastole blood pressure
  
```{r}
moderation_DI = lm(DI ~ DBD100 + BMXWAIST + DBD100 * BMXWAIST, data)
summary(moderation_DI)
```
<br>
  
#### Moderation at one standard deviation above mean for diastole blood pressure
  
```{r}
data$BMXWAIST_high = data$BMXWAIST + sd(data$BMXWAIST)
moderation_DI_high = lm(DI ~ DBD100 + BMXWAIST_high + DBD100 * BMXWAIST_high, data)
summary(moderation_DI_high)
```
<br>
  
#### Modetation at one standard deviation below mean for diastole blood pressure
  
```{r}
data$BMXWAIST_low = data$BMXWAIST - sd(data$BMXWAIST)
moderation_DI_low = lm(DI ~ DBD100 + BMXWAIST_low + DBD100 * BMXWAIST_low, data)
summary(moderation_DI_low)
```


##### Since the regression coefficient for the interation term is not significant with p value 0.41, there does not exist a significant moderation effect. The effect of salt intake on diastole blood pressure may not depend on waist size.
<br>
  
#### Simple Slope analysis for diastole blood pressure
<br>
  
##### We find beta0 and beta1 values of the independent variable DBD100 (salt intake) from the three regression models: (1) with the moderator held at mean (2) with the moderator held at one standard deviation below mean (3) with the moderator held at one standard deviation above mean.
  
##### Then, for each of these three models, we predict the dependent variable Y = beta0 + beta1 * X (here Y is blood pressure DI and X is the salt intake DBD100). By analysing the characteristic of Y at three levels of the moderator, we can compare the behaviors of moderator at three levels. In our case, we are seeing if people with waist size one standard deviation below mean and one standard deviation above mean have different blood pressure characteristics compared to people with waist size at mean.
<br>
  
```{r}
# moderator is at mean: b0 = 0.010034, b1 = 0.596273
meanDI = moderation_DI$coefficients[1] + moderation_DI$coefficients[2] * data$DBD100

# moderator is one standard deviation above mean: b0 = -3.928731, b1 = 0.785543
highDI = moderation_DI_high$coefficients[1] + moderation_DI_high$coefficients[2] * data$DBD100

# moderator is one standard deviation below mean: bo = 3.948800, b1 = 0.407004
lowDI = moderation_DI_low$coefficients[1] + moderation_DI_low$coefficients[2] * data$DBD100

# plot the three dependent values vs salt intake
plot(data$DBD100, meanDI, type = "l", col = "green", ylim = c(-5, 7), xlab = "Salt intake", ylab = "Diastole blood pressure")
lines(data$DBD100, lowDI, col = "red")
lines(data$DBD100, highDI, col = "blue")
```

#####  The green line shows the relationship between salt intake and diastole blood pressure when the moderator waist size is at mean.The red line is for the moderator one standard deviation below the mean snd the blue line is for one standard deviation above mean.

##### we can see from the plot that people with a higher waist size have a higher effect on the blood pressure, meaning the moderation effect of waist size on blood pressure through salt intake is higher for people with a higher waist size, but they are not significantly different between different levels of waist sizes.
<br>
  
#### Moderation at mean for systole blood pressure
  
```{r}
moderation_SY = lm(SY ~ DBD100 + BMXWAIST + DBD100 * BMXWAIST, data)
summary(moderation_SY)
```
<br>
  
#### Moderation at one standard deviation above mean for systole blood pressure
  
```{r}
data$BMXWAIST_high = data$BMXWAIST + sd(data$BMXWAIST)
moderation_SY_high = lm(SY ~ DBD100 + BMXWAIST_high + DBD100 * BMXWAIST_high, data)
summary(moderation_SY_high)
```
<br>
  
#### Moderation at one standard deviation below mean for diastole blood pressure
  
```{r}
data$BMXWAIST_low = data$BMXWAIST - sd(data$BMXWAIST)
moderation_SY_low = lm(SY ~ DBD100 + BMXWAIST_low + DBD100 * BMXWAIST_low, data)
summary(moderation_SY_low)
```


##### Since the regression coefficient for the interation term is not significant with p value 0.51, there does not exist a significant moderation effect. The effect of salt intake on systole blood pressure may not depend on waist size as well.
<br>
  
#### Simple slope analysis for systole blood pressure
<br>
  
##### The method is the same as diastole blood pressure.
  
```{r}

# moderator is at mean: b0 = -0.009924, b1 = 0.610168
meanSY = moderation_SY$coefficients[1] + moderation_SY$coefficients[2] * data$DBD100

# moderator is one standard deviation above mean: b0 = -7.230880, b1 = 0.422982
highSY = moderation_SY_high$coefficients[1] + moderation_SY_high$coefficients[2] * data$DBD100

# moderator is one standard deviation below mean: bo = 7.221033, b1 = 0.797353
lowSY = moderation_SY_low$coefficients[1] + moderation_SY_low$coefficients[2] * data$DBD100

# plot the three dependent values vs salt intake
plot(data$DBD100, meanSY, type = "l", col = "green", ylim = c(-10, 15), xlab = "Salt intake", ylab = "Systole blood pressure")
lines(data$DBD100, lowSY, col = "red")
lines(data$DBD100, highSY, col = "blue")
```

#####  The green line shows the relationship between salt intake and systole blood pressure when the moderator waist size is at mean.The red line is for the moderator one standard deviation below the mean and the blue line is for one standard deviation above mean.

##### we can see from the plot that people with a lower waist size have a higher effect on the systole blood pressure, meaning the moderation effect of waist size on blood pressure through salt intake is higher for people with a lower waist size, but they are also not significantly different between different levels of waist sizes.
<br>
  
### Mediation Part
  
##### We perform mediation to test if the relationship between salt intake and blood pressure mediated by age.
##### First, we test if there is relationship between age and salt intake, since mediation makes sense only if they have relationship.
  
```{r}
age_salt_DI = lm(RIDAGEYR ~ DBD100, data)
summary(age_salt_DI)
```


##### The p_value is 5.31e-10. They have strong relationship.
<br>
  
#### Second, perform the mediation analysis
<br>
  
##### For diastole blood pressure
  
```{r}
mediation_DI = lm(DI ~ DBD100 + RIDAGEYR, data)
summary(mediation_DI)
```


#### Third, perform the mediation through bootstrapping
<br>
  
##### For diastole blood pressure
  
```{r}
mediation_boot_DI1 = mediation(x = data$DBD100, 
                               mediator = data$RIDAGEYR,
                               dv = data$DI,
                               conf.level = 0.95,
                               bootstrap = TRUE,
                               B = 1000, 
                               which.boot = "Percentile")
```

```{r}
mediation_boot_DI1
```
##### The indirect effect (0.37655) and its confidence interval is different from zero. Age is a mediator between salt intake and diastole blood pressure.
<br>
  

![Fig 2: Direct and indirect effects of the mediation analysis for Diastole ](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig2.png)


##### The effect of salt intake on diastole blood pressure still exists(p-value is 0.021), but in a smaller magnitude. Age partially mediates between salt intake and diastole blood pressure.
<br>

##### For systole blood pressure
  
```{r}
mediation_SY = lm(SY ~ DBD100 + RIDAGEYR, data)
summary(mediation_SY)
```

##### The effect of salt intake on systole blood pressure disappear (p-value is 0.741). Age fully mediates salt intake and systole blood pressure.
<br>
  
#### Perform the mediation through bootstrapping for systole
```{r}
mediation_boot_SY1 = mediation(x = data$DBD100, 
                               mediator = data$RIDAGEYR,
                               dv = data$SY,
                               conf.level = 0.95,
                               bootstrap = TRUE,
                               B = 1000, 
                               which.boot = "Percentile")
```

```{r}
mediation_boot_SY1
```

![Fig 3: Direct and indirect effects of the mediation analysis for Diastole ](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig3.png)

##### The estimate indirect effect(1.054) and its confidence interval is different from zero. Age is a mediator between salt intake and systole blood pressure.




## SAS

```{r, echo = TRUE, eval=FALSE}
libname results 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/results';
libname rawdata 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData';
libname home 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/home';
```


### Load the data

```{r, echo = TRUE, eval=FALSE}

%let demographics = 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/demographics_15_16.csv';
%let BMI = 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Body_measures_2015_16.csv';
%let blood_pressure = 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Blood_Pressure_2015_16.csv';
%let nutrients_1day = 'C:/Users/djbranglab-admin/Desktop/stats506-master/stats506-master/RawData/Dietary_nutrients_firstday_2015_16.csv';

/* Import demographic data */ 
  proc import file = &demographics 
out=home.demographics dbms=csv replace; 
guessingrows=max; 
getnames = Yes ; 
run;

/* Import BMI data */ 
  proc import file = &BMI   
out=home.BMI dbms=csv replace; 
guessingrows=max;
getnames = Yes ;
run;

/* Import blood pressure data */ 
  proc import file = &blood_pressure   
out=home.blood_pressure  dbms=csv replace; 
guessingrows=max;
getnames = Yes ;
run;

/* Import nutrients data */ 
  proc import file = &nutrients_1day   
out=home.nutrients_1day  dbms=csv replace; 
guessingrows=max;
getnames = Yes ;
run;

```
<br>
  
### Data processing
  
```{r, echo = TRUE, eval = FALSE}
/* Merge all required data with SEQN as key*/ 
  proc sql;
create table home.merged_data as select 
A.SEQN, A.RIDAGEYR, 
B.BMXWAIST, 
C.DBD100,
D.BPXSY1, D.BPXSY2, D.BPXSY3, D.BPXDI1, D.BPXDI2, D.BPXDI3 from
home.demographics as A inner join 
home.BMI as B on 
A.SEQN = B.SEQN inner join 
home.nutrients_1day as C on 
A.SEQN = C.SEQN inner join 
home.blood_pressure as D on
A.SEQN = D.SEQN;
quit;

/* Find mean of systole and diastole from all three observations*/ 
  data home.mean_merged_data(DROP=BPXSY1 BPXSY2 BPXSY3 BPXDI1 BPXDI2 BPXDI3);
set home.merged_data;
BPXSY=mean(of BPXSY1-BPXSY3);
BPXDI=mean(of BPXDI1-BPXDI3);
run;

/* Drop rows with missing values*/ 
  data home.mean_merged_data;
set home.mean_merged_data;
if not cmiss(BMXWAIST,DBD100,BPXSY,BPXDI);
run;

```

#### Center means to reduce multicolinearity

```{r, echo = TRUE, eval = FALSE}
proc sql; 
create table home.mean_centered_data as
select SEQN,
RIDAGEYR - mean(RIDAGEYR) as RIDAGEYRmc, 
BMXWAIST - mean(BMXWAIST) as BMXWAISTmc,
DBD100 - mean(DBD100) as DBD100mc,
BPXDI - mean(BPXDI) as BPXDImc,
BPXSY - mean(BPXSY) as BPXSYmc
from home.mean_merged_data;
quit;
```
<br>
  
#### Create the moderator variables at one SD above and below mean and the interaction terms  
```{r, echo = TRUE, eval = FALSE}
/* Create + and - one SD of the dependent variable for moderation analysis */ 
proc sql;
create table home.mean_centered_data as 
select *, 
BMXWAISTmc - std(BMXWAISTmc) as BMXWAISTlow,
BMXWAISTmc + std(BMXWAISTmc) as BMXWAISThigh  
from home.mean_centered_data;
quit; 

/* Create the interaction term for use in the moderator model */ 
data home.mean_centered_data;
set home.mean_centered_data;
DBD100mc_BMXWAISTmc=DBD100mc*BMXWAISTmc;
DBD100mc_BMXWAISTlow=DBD100mc*BMXWAISTlow;
DBD100mc_BMXWAISThigh=DBD100mc*BMXWAISThigh;
run;

```
### Analyse the relationship between salt intake and two kinds of blood pressure
<br>
  
#### For diastole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data= home.mean_centered_data;
model BPXDImc = DBD100mc;
title ' Regression model / testing relationship between Diastole and salt intake' ;
run; 
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig4.png)
<br>
  
#### For systole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data= home.mean_centered_data;
model BPXSYmc = DBD100mc;
title ' Regression model / testing relationship between Systole and salt intake' ;
run; 
```

![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig5.png)
<br>

##### Both p-values are less than 0.001, which show strong evidence that salt intake have siginificant influence on both kinds of blood pressure.
<br>
  
### Moderation part
  
##### We perform moderation to test if the relationship is dependent on the waist size. Three levels of a moderator(mean, one standard deviation above the mean and one standard deviation below the mean) are chosen.
<br>
  
#### Moderation at mean for diastole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data=home.mean_centered_data;
model BPXDImc = DBD100mc BMXWAISTmc DBD100mc_BMXWAISTmc / pcorr2 scorr2;
title ' Regression model / testing moderator effect of waist size on diastole and salt intake at mean' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig6.png)
<br>

<br>
  
#### Moderation at one standard deviation above mean for diastole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data=home.mean_centered_data;
model BPXDImc = DBD100mc BMXWAISTmc DBD100mc_BMXWAISThigh / pcorr2 scorr2;
title ' Regression model / testing moderator effect of waist size on diastole and salt intake one SD above mean' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig7.png)
<br>

<br>
  
#### Moderation at one standard deviation below mean for diastole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data=home.mean_centered_data;
model BPXDImc = DBD100mc BMXWAISTlow DBD100mc_BMXWAISTlow / pcorr2 scorr2;
title ' Regression model / testing moderator effect of waist size on diastole and salt intake one SD below mean' ;
run;
```

![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig8.png)
<br>

##### Since the regression coefficient for the interation term is not significant with p value 0.41, there does not exist a significant moderation effect. The effect of salt intake on diastole blood pressure may not depend on waist size.

<br>
  
  
#### Moderation at mean for systole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data=home.mean_centered_data;
model BPXSYmc = DBD100mc BMXWAISTmc DBD100mc_BMXWAISTmc / pcorr2 scorr2;
title ' Regression model / testing moderator effect of waist size on systole and salt intake at mean' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig9.png)

<br>
  
#### Moderation at one standard deviation above mean for systole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data=home.mean_centered_data;
model BPXSYmc = DBD100mc BMXWAISThigh DBD100mc_BMXWAISThigh / pcorr2 scorr2;
title ' Regression model / testing moderator effect of waist size on systole and salt intake one SD above mean' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig10.png)

<br>
  
  
#### Moderation at one standard deviation below mean for systole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc reg data=home.mean_centered_data;
model BPXSYmc = DBD100mc BMXWAISTlow DBD100mc_BMXWAISTlow / pcorr2 scorr2;
title ' Regression model / testing moderator effect of waist size on systole and salt intake one SD below mean' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig11.png)

##### Since the regression coefficient for the interation term is not significant with p value 0.51, there does not exist a significant moderation effect. The effect of salt intake on systole blood pressure may not depend on waist size as well.
<br>

  
### Mediation Part
  
##### We perform mediation to test if the relationship between salt intake and blood pressure mediated by age.
##### First, we test if there is relationship between age and salt intake, since mediation makes sense only if they have relationship.
  
```{r, echo = TRUE, eval = FALSE}
proc reg data = home.mean_centered_data;
model RIDAGEYRmc = DBD100mc; 
title ' Regression model / Checking relationship between age and salt intake' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig12.png)

##### The p_value is 5.31e-10. They have strong relationship.
<br>
  
#### Second, perform the mediation 
<br>
  
##### For diastole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc causalmed data=home.mean_centered_data;
model BPXDImc = DBD100mc RIDAGEYRmc;
mediator RIDAGEYRmc = DBD100mc;
title ' Regression model / check the effect of age as a mediator between the relationship of Diastolic BP and salt intake' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig13.png)

##### The effect of salt intake on diastole blood pressure still exists(p-value is 0.021), but in a smaller magnitude. Age partially mediates between salt intake and diastole blood pressure.
<br>
  
##### For systole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc causalmed data=home.mean_centered_data;
model BPXSYmc = DBD100mc RIDAGEYRmc;
mediator RIDAGEYRmc = DBD100mc;
title ' Regression model / check the effect of age as a mediator between the relationship of Systolic BP and salt intake' ;
run;
```

![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig14.png)
##### The effect of salt intake on systole blood pressure disappear (p-value is 0.741). Age fully mediates salt intake and systole blood pressure.
<br>
  
#### Third, perform the mediation through bootstrapping
<br>
  
##### For diastole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc causalmed data=home.mean_centered_data;
model BPXDImc = DBD100mc RIDAGEYRmc;
mediator RIDAGEYRmc = DBD100mc;
bootstrap NBOOT = 1000;
title ' Regression model / check the effect of age as a mediator between the relationship of Diastolic BP and salt intake using bootstrap' ;
run;
```
![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig15.png)

![Direct and indirect effects of the mediation analysis for Diastole ](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig2.png)

##### The indirect effect (0.37655) and its confidence interval is different from zero. Age is a mediator between salt intake and diastole blood pressure.
<br>
  
##### For systole blood pressure
  
```{r, echo = TRUE, eval = FALSE}
proc causalmed data=home.mean_centered_data;
model BPXSYmc = DBD100mc RIDAGEYRmc;
mediator RIDAGEYRmc = DBD100mc;
bootstrap NBOOT = 1000;
title ' Regression model / check the effect of age as a mediator between the relationship of Systolic BP and salt intake using bootstrap' ;
run;
```

![](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig16.png)

##### The estimate indirect effect(1.054) and its confidence interval is different from zero. Age is a mediator between salt intake and systole blood pressure.

![Direct and indirect effects of the mediation analysis for Systole ](C:\\Users\\djbranglab-admin\\Desktop\\stats506-master\\stats506-master\\RawData\\fig3.png)

## Python

Required software and packages to run the code are as follows:
* Python3 
* os
* pandas
* statsmodels
* patsy
* matplotlib

```{python, eval=F}
# Import packages
import os
import pandas as pd
from statsmodels.formula.api import ols
from statsmodels.stats.anova import anova_lm
import patsy
from statsmodels.api import OLS
from statsmodels.stats.mediation import Mediation
import matplotlib.pyplot as plt
```
```{python, eval=F}
# Set working directory
os.chdir('D:/学习/密歇根/STAT506/Group project/stats506/')

# read data
demo = pd.read_excel("RawData/Demographics_15_16.xlsx")
BMI = pd.read_excel("RawData/Body_measures_2015_16.xlsx")
bp = pd.read_excel('RawData/Blood_Pressure_2015_16.xlsx')
nutr = pd.read_excel("RawData/Dietary_nutrients_firstday_2015_16.xlsx")
```

### Data cleaning

We need first clean the raw data and join different dataset.

```{python, eval=F}
# select useful columns
# ! Note: we need to drop values '9' or '99' which represent "don't know"
demo=demo.set_index('SEQN'
                    ).filter(items=['RIDAGEYR']  # 'RIAGENDR','RIDRETH3'
                    ).dropna()
# demo[['RIAGENDR','RIDRETH3']]=demo[['RIAGENDR','RIDRETH3']].astype('category')
BMI=BMI.set_index('SEQN'
                  ).filter(items=['BMXWAIST']   # ,'BMXWT','BMXHT'
                  ).dropna()
nutr=nutr.set_index('SEQN'
                    ).filter(items=['DBD100']  #,'DBQ095Z','DRQSPREP'
                    ).dropna(
                    ).query('DBD100 != 9'
                    ).astype('category')

# Calculate mean of blood pressure
bp=bp.set_index('SEQN'
                ).filter(regex='(BPXSY*)|(BPXDI*)')
bp=bp.assign(SY=bp.filter(regex='BPXSY*').mean(axis=1, skipna = True),
             DI=bp.filter(regex='BPXDI*').mean(axis=1, skipna = True)
             ).filter(items=['SY','DI']).dropna()

# Merge all data set
df=bp.join(demo,how='inner').join(BMI,how='inner').join(nutr,how='inner')
```
Take a look at the data we worked on.

```{python, eval=F}
# Show data summary of numeric variables
df.describe()
# Show data summary of categorical variables
df.describe(include='category')
# plot Diastolic and salt intakes
DI_salt=df[['DBD100','DI']
            ].pivot(columns='DBD100', values='DI'
            )
DI_salt.columns=["Rarely","Occasionally","Very often"]
DI_salt.boxplot(grid=False)
plt.title("Boxplot of Diastolic and frequency of add salt to food at table")
plt.suptitle("")
plt.show()
# plot Systolic and salt intakes
SY_salt=df[['DBD100','SY']
            ].pivot(columns='DBD100', values='SY'
            )
SY_salt.columns=["Rarely","Occasionally","Very often"]
SY_salt.boxplot(grid=False)
plt.title("Boxplot of Systolic and frequency of add salt to food at table")
plt.suptitle("")
plt.show()
```
```{python}
# Test normality of Diastolic given salt intake
ax1 = plt.subplot(131)
a=DI_salt[['Rarely']].dropna().to_numpy()
a=np.reshape(a,(len(a)))
qqplot = stats.probplot(a, plot=plt)
plt.yticks([])

ax2 = plt.subplot(132)
b=DI_salt[['Occasionally']].dropna().to_numpy()
b=np.reshape(b,(len(b)))
qqplot = stats.probplot(b, plot=plt)
plt.yticks([])

ax3 = plt.subplot(133)
c=DI_salt[['Very often']].dropna().to_numpy()
c=np.reshape(c,(len(c)))
qqplot = stats.probplot(c, plot=plt)
plt.yticks([])

ax1.set_title('Rarely')
ax2.set_title('Occasionally')
ax3.set_title('Very often')

plt.show()
# Test normality of Systolic given salt intake
ax1 = plt.subplot(131)
a=SY_salt[['Rarely']].dropna().to_numpy()
a=np.reshape(a,(len(a)))
qqplot = stats.probplot(a, plot=plt)
plt.yticks([])

ax2 = plt.subplot(132)
b=SY_salt[['Occasionally']].dropna().to_numpy()
b=np.reshape(b,(len(b)))
qqplot = stats.probplot(b, plot=plt)
plt.yticks([])

ax3 = plt.subplot(133)
c=SY_salt[['Very often']].dropna().to_numpy()
c=np.reshape(c,(len(c)))
qqplot = stats.probplot(c, plot=plt)
plt.yticks([])

ax1.set_title('Rarely')
ax2.set_title('Occasionally')
ax3.set_title('Very often')

plt.show()
```


### Fit OLS

Now fit the ordinary least square to the data.
The models used are:
`DI ~ DBD100` and `SY ~ DBD100`

#### Diastolic
```{python}
# fit ols to Diastolic measurements
ols_DI=ols('DI~DBD100',data=df).fit()
# Print the summary
ols_DI.summary()
anova_lm(ols_DI)
```

#### Systolic
```{python}
# fit ols to Systolic measurements
ols_SY=ols('SY~DBD100',data=df).fit()
# Print the summary
ols_SY.summary()
anova_lm(ols_SY)
```
### Moderation effect of waist size
First, add two columns recording a standiviation above and below of waist size.

```{python}
f['waist_sd'] = df['BMXWAIST'].std()
df['waist_up']=df['BMXWAIST']+df['waist_sd']
df['waist_down']=df['BMXWAIST']-df['waist_sd']
```

#### Diastolic
Fit model: DI ~ DBD100 + BMXWAIST + DBD100 * BMXWAIST
```{python}
moderation_DI = ols('DI ~ DBD100 + BMXWAIST + DBD100 * BMXWAIST', data=df).fit()
moderation_DI.summary()
anova_lm(moderation_DI)
# one standard deviation above mean
moderation_DI_up = ols('DI ~ DBD100 + waist_up + DBD100 * waist_up', data=df).fit()
moderation_DI_up.summary()
# one standard deviation below mean
moderation_DI_down = ols('DI ~ DBD100 + waist_down + DBD100 * waist_down', data=df).fit()
moderation_DI_down.summary()
```
#### Systolic
Fit model: SY ~ DBD100 + BMXWAIST + DBD100 * BMXWAIST

```{python}
moderation_SY = ols('SY ~ DBD100 + BMXWAIST + DBD100 * BMXWAIST', data=df).fit()
moderation_SY.summary()
anova_lm(moderation_SY)
# one standard deviation above mean
moderation_SY_up = ols('SY ~ DBD100 + waist_up + DBD100 * waist_up', data=df).fit()
moderation_SY_up.summary()
# one standard deviation below mean
moderation_SY_down = ols('SY ~ DBD100 + waist_down + DBD100 * waist_down', data=df).fit()
moderation_SY_down.summary()
```
### Mediation effect of age
Fit model: RIDAGEYR ~ DBD100 to see if there are relationships between age and salt intake

```{python}
# test if there is relationship between age and salt intake.
age_D = ols('RIDAGEYR ~ DBD100', data=df).fit()
age_D.summary()
```
#### Diastolic
Fit model: DI ~ DBD100 + RIDAGEYR.

```{python}
mediation_DI = ols('DI ~ DBD100 + RIDAGEYR', data=df).fit()
mediation_DI.summary()
# Create design matrix
DI,model_mat = patsy.dmatrices("DI ~ DBD100 + RIDAGEYR", data=df)
df_med_DI=pd.DataFrame(model_mat).iloc[:,1:]
df_med_DI.columns=['DBD2','DBD3','RIDAGEYR']
df_med_DI['DI']=DI

# origin model and mediator model
med_model_DI=OLS.from_formula('DI ~ RIDAGEYR+DBD2+DBD3', data=df_med_DI)
mediator_DI=OLS.from_formula('RIDAGEYR ~ DBD2+DBD3', data=df_med_DI)

# origin model and mediator model
med_DI = Mediation(med_model_DI,mediator_DI,['DBD2','DBD3'],'RIDAGEYR').fit()
med_DI.summary()
```
#### Systolic
Fit model: SY ~ DBD100 + RIDAGEYR.

```{python}
mediation_SY = ols('SY ~ DBD100 + RIDAGEYR', data=df).fit()
mediation_SY.summary()

# Create design matrix
SY,model_mat = patsy.dmatrices("SY ~ DBD100 + RIDAGEYR", data=df)
df_med_SY=pd.DataFrame(model_mat).iloc[:,1:]
df_med_SY.columns=['DBD2','DBD3','RIDAGEYR']
df_med_SY['SY']=SY

# origin model and mediator model
med_model_SY=OLS.from_formula('SY ~ RIDAGEYR+DBD2+DBD3', data=df_med_SY)
mediator_SY=OLS.from_formula('RIDAGEYR ~ DBD2+DBD3', data=df_med_SY)

# origin model and mediator model
med_SY = Mediation(med_model_SY,mediator_SY,['DBD2','DBD3'],'RIDAGEYR').fit()
med_SY.summary()
```



# Results
Moderation analysis results are seen in the tables above. 
#### Moderation results for Diastole: 
The overall model was significant F(3, 4678) = 154.5, p<0.001, \(R\)^2^ = 0.09, with main effect of waist size positively predicting diastolic blood pressure. However, the interaction was not significant, indicating that though there exists a positive relation between waist size and diastolic blood pressure as well as a positive relation between salt intake and diastolic blood pressure, there does not exist a moderating effect of waist size on the relationship between salt intake and diastolic blood pressure. Simple slopes analysis does not indicate significant differences between predictions at different levels of standard deviations of the moderator. 

#### Moderation results for Systole: 
The overall model was significant F(3, 4678) = 333.7, p<0.001, \(R\)^2^ = 0.17, with main effect of waist size positively predicting systolic blood pressure. However, the interaction was not significant, indicating that though there exists a positive relation between waist size and systolic blood pressure as well as a positive relation between salt intake and systolic blood pressure, there does not exist a moderating effect of waist size on the relationship between salt intake and systolic blood pressure.Simple slopes analysis does not indicate significant differences between predictions at different levels of standard deviations of the moderator. 

#### Mediation results for diastole: 

Mediation analysis performed to analyze the mediating effect of age on the relationship between salt intake and diastolic blood pressure was significant, F(2,4679) = 182.7, p <0.001, \(R\)^2^ = 0.07, indicating that there exists a positive relationship between salt intake and blood pressure. More importantly, there exists a positive, significant indirect effect in the relationship between salt intake and diastolic blood pressure, b = 0.38, 95% CI (0.25, 0.52), p < 0.001, indicating a mediating effect of age on the effect of salt intake and diastolic blood pressure. 

#### Mediation results for systole: 

Mediation analysis performed to analyze the mediating effect of age on the relationship between salt intake and systolic blood pressure was significant, F(2,4679) = 1133, p <0.001, \(R\)^2^ = 0.32, indicating that there exists a positive relationship between salt intake and blood pressure. More importantly, there exists a positive, significant indirect effect in the relationship between salt intake and diastolic blood pressure, b = 1.05, 95% CI (0.71, 1.40), p < 0.001, indicating a mediating effect of age on the effect of salt intake and systolic blood pressure. 

<br>
  
# Discussion
<br>
  
# References
Baron, R. M., & Kenny, D. A. (1986). The moderator–mediator variable distinction in social psychological research: Conceptual, strategic, and statistical considerations. Journal of Personality and Social Psychology, 5, 1173-1182.

Imai, K., Keele, L., & Tingley, D. (2010). A general approach to causal mediation analysis. Psychological methods, 15(4), 309.

Shrout, P. E., & Bolger, N. (2002). Mediation in experimental and nonexperimental studies: new procedures and recommendations. Psychological Methods, 7, 422-445.

Tingley, D., Yamamoto, T., Hirose, K., Keele, L., & Imai, K. (2014). Mediation: R package for causal mediation analysis.